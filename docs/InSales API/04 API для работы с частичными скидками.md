# API для работы с частичными скидками

Частичная скидка — это скидка, которая распространяется не на все позиции в заказе, а только на некоторые. Чтобы понять, на какие именно позиции действует частичная скидка, используется параметр discount\_order\_lines\_ids. Этот параметр является массивом идентификаторов позиций заказа (order\_line.id), которые могут быть заданы в числовом или строковом представлении. Если скидка действует сразу на все позиции (не является частичной), то указанный параметр discount\_order\_lines\_ids либо содержит идентификаторы всех позиций, либо его значение отсутствует вовсе.

Кроме массива discount\_order\_lines\_ids в ответах на запросы присутствует еще один параметр discount\_products\_ids — массив, содержащий идентификаторы товаров, на которые действует скидка. Параметр discount\_products\_ids будет правильно обработан и в запросах, если указать его вместо discount\_order\_lines\_ids.

К сожалению, существует ряд случаев, когда невозможно установить взаимно-однозначное соответсвие между идентификаторами в массивах discount\_order\_lines\_ids и discount\_products\_ids. Самым простым примером является случай, когда в заказе присутствуют две модификации одного и того же товара, но скидка должна распространяться только на одну из этих модификаций.

Однако есть и более сложные ситуации, когда в заказе присутствуют две позиции с одинаковыми product\_id и variant\_id, а скидка, при этом, распространяется только на одну из этих позиций. И это — штатное поведение, а подобные случаи встречаются на практике не так уж и редко, особенно, если магазин использует комплекты.

Предположим, что у нас есть комплект K состоящий из двух товаров (A и B). Этот комплект уценен, и скидки на него не распространяются. А на товары A и B — распространяются (если покупать их вне комплекта). Покупатель кладет в корзину комплекты К и товар A. У клиента есть накопительная скидка. Она применяется только к товару А. К товару K скидка не применяется, так как он уценен. Казалось бы, все хорошо, ведь в корзине два разных товара К и A. Но при создании заказа (в ходе расщепления комплекта) К превращается в A и B. Вот такой у нас получится заказ:

1.  A - на эту позицию действует скидка.

2.  A из комплекта К, у него другая цена, и скидка на него не распространяется.

3.  B из комплекта К, на него тоже не распространяется скидка.


Какие отсюда следуют выводы:

1.  Нельзя идентифицировать позицию по variant\_id (и уж тем более по product\_id, а до недавнего времени это был единственный способ для частичных скидок).

2.  Если вы использовали discount\_products\_ids, то надо переходить на discount\_order\_lines\_ids.

3.  Если вы не хотите знать как InSales размазывает скидку по позициям, то можно не лезть в эти дебри. Достаточно использовать full\_total\_price у позиций заказа order\_lines, там уже всё посчитано.


Важно отметить, что по идеологическим соображениям внешние частичные скидки пока не поддерживают discount\_order\_lines\_ids, и для них по-прежнему необходимо передавать discount\_products\_ids. Работу внешних скидок пока переделывать не стали, т.к. они вычисляются до расщепления комплектов. Если же попробовать их применить к уже созданному заказу, то приложение получит расщепленный состав заказа. Так как в большинстве случаев внешние скидки нужны при создании заказа, мы этот момент пока не стали править.

Другим важным моментом является то, что одновременное указание в параметрах обоих массивов discount\_order\_lines\_ids и discount\_products\_ids (в т.ч. с противоречивыми значениями) не приведет к ошибке, но это крайне нежелательно, т.к. результат расчета скидки в случаях, когда нет взаимно-однозначного соответствия идентификаторов, сложно предсказать. Поэтому не следует этого делать даже в тех случаях, когда есть необходимость использовать параметр discount\_products\_ids.

API InSales не предоставляет средств для применения к заказу частичных скидок во время создания заказа с помощью параметра discount\_order\_lines\_ids, а параметр discount\_products\_ids по описанным выше причинам использовать не следует. Однако теперь API позволяет создать или добавить частичную скидку к уже созданному заказу, либо сделать частичной ранее примененную скидку (в т.ч. скидочный купон). Для этого необходимо при обновлении заказа указать параметр discounts\_attributes — массив хешей, содержащих атрибуты применяемых к заказу скидок, в т.ч. discount\_order\_lines\_ids.

Параметр discounts в ответе на запрос обновления заказа содержит атрибуты всех примененных скидок. Параметр discount (в единственном числе) — псевдоним для первого элемента массива discounts, он используется для обратной совместимости и не рекомендуется к использованию в новом программном коде.
